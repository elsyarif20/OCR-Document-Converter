<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCR & Research Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SCRIPT KANVAS WAJIB -->
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <!-- Library Tesseract.js untuk OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: "Inter", sans-serif;
    }
    
    * {
      box-sizing: inherit;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .card-shadow {
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .result-section {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
    }
    
    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #48bb78;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .progress-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s ease;
    }
    
    .hidden {
      display: none;
    }
    
    .tab-active {
      background-color: #667eea !important;
      color: white !important;
    }
    
    .tab-inactive {
      background-color: #f7fafc;
      color: #4a5568;
    }
    
    .chapter-item {
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .chapter-item:hover {
      background-color: #edf2f7;
    }
    
    .ris-entry {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      background: #f7fafc;
      padding: 12px;
      border-radius: 6px;
      white-space: pre-wrap;
      margin-top: 8px;
    }
    
    .toast.error {
        background-color: #f56565;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="w-full min-h-full">
  <div class="w-full min-h-full gradient-bg">
   <div class="w-full px-4 py-8">
    <div class="max-w-6xl mx-auto">
     <div class="text-center mb-8">
      <h1 id="app-title" class="text-white text-3xl font-extrabold mb-2" style="font-family: 'Segoe UI', Tahoma, sans-serif;">OCR & Research Assistant</h1>
      <p id="instruction-text" class="text-white text-lg" style="font-family: 'Segoe UI', Tahoma, sans-serif;">Pilih fitur: OCR Scanner atau Asisten Karya Ilmiah</p>
     </div>
     <div class="bg-white rounded-xl p-2 card-shadow mb-6">
      <div class="flex gap-2"><button id="tabOCR" class="flex-1 py-3 px-4 rounded-lg transition-colors font-semibold tab-active" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> ğŸ“¸ OCR Scanner </button> <button id="tabResearch" class="flex-1 py-3 px-4 rounded-lg transition-colors font-semibold tab-inactive" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> ğŸ“ Asisten Karya Ilmiah </button>
      </div>
     </div>
     <div id="ocrSection">
      <div class="bg-white rounded-xl p-6 card-shadow mb-6">
       <div class="mb-4"><label class="block mb-2 font-bold" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> <span>ğŸ“ </span><span id="upload-label">Pilih Gambar</span> </label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3"><button id="uploadBtn" class="w-full py-3 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> ğŸ“‚ Upload dari Galeri </button> <button id="cameraBtn" class="w-full py-3 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center gap-2 font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> ğŸ“¸ Ambil Foto Langsung </button>
        </div><input type="file" id="imageInputGallery" accept="image/*" class="hidden"> <input type="file" id="imageInputCamera" accept="image/*" capture="environment" class="hidden">
       </div>
       <div class="mb-4"><img id="previewImage" class="hidden w-full max-h-96 object-contain rounded-lg border-2 border-gray-200" alt="Preview">
       </div>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸŒ Bahasa Objek</label> <select id="objectLang" class="w-full p-3 border-2 border-gray-300 rounded-lg"> <option value="ind">Indonesia</option> <option value="eng">English</option> <option value="ind+eng">Campuran (IND+ENG)</option> <option value="jpn">Japanese</option> <option value="chi_sim">Chinese Simplified</option> <option value="ara">Arabic</option> <option value="fra">French</option> <option value="deu">German</option> <option value="spa">Spanish</option> </select>
        </div>
        <div><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“„ Format Output</label> <select id="outputFormat" class="w-full p-3 border-2 border-gray-300 rounded-lg"> <option value="txt">Plain Text (.txt)</option> <option value="word">Word (.doc)</option> <option value="markdown">Markdown (.md)</option> <option value="csv">CSV (.csv)</option> </select>
        </div>
       </div><button id="processBtn" class="w-full text-white py-3 rounded-lg transition-colors font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #667eea;"> <span id="process-btn-text">ğŸ” Ekstrak Teks</span> </button>
       <div id="loadingIndicator" class="hidden text-center mt-4">
        <div class="loading-spinner mx-auto"></div>
        <p id="loadingText" class="mt-2 text-gray-700 font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif;">Memuat OCR Engine...</p>
        <div class="progress-bar">
         <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>
        <p id="progressText" class="mt-1 text-sm text-gray-600" style="font-family: 'Segoe UI', Tahoma, sans-serif;">0%</p>
       </div>
      </div>
      <div id="resultsSection" class="hidden bg-white rounded-xl p-6 card-shadow mb-6">
       <h2 class="text-xl font-bold mb-4" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“‹ Hasil Ekstraksi</h2>
       <div class="mb-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
        <h3 class="font-semibold mb-2" style="font-family: 'Segoe UI', Tahoma, sans-serif;">Ringkasan</h3>
        <p id="summaryText" class="text-gray-700" style="font-family: 'Segoe UI', Tahoma, sans-serif;"></p>
       </div>
       <div class="mb-6 p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
        <h3 class="font-semibold mb-2" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“Š Akurasi</h3>
        <div class="flex items-center gap-3">
         <div class="flex-1 bg-gray-200 rounded-full h-4">
          <div id="confidenceBar" class="bg-green-500 h-4 rounded-full transition-all" style="width: 0%"></div>
         </div><span id="confidenceText" class="font-semibold text-gray-700" style="font-family: 'Segoe UI', Tahoma, sans-serif;">0%</span>
        </div>
       </div>
       <div class="mb-6">
        <h3 class="font-semibold mb-2" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“ Teks Lengkap</h3>
        <div id="extractedText" class="p-4 bg-gray-50 rounded-lg result-section" style="font-family: 'Segoe UI', Tahoma, sans-serif; white-space: pre-wrap;"></div>
       </div>
       <div class="flex flex-wrap gap-3"><button id="downloadBtn" class="px-6 py-2 text-white rounded-lg hover:opacity-90 transition-colors font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #764ba2;"> ğŸ’¾ Download Hasil </button> <button id="copyOCRBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> ğŸ“‹ Copy Teks </button> <button id="saveOCRBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> ğŸ“Š Simpan ke Canvas Sheet </button> <button id="translateBtn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> ğŸŒ Terjemahkan </button>
       </div>
      </div>
     </div>
     <div id="researchSection" class="hidden">
      <div class="bg-white rounded-xl p-6 card-shadow mb-6">
       <h2 class="mb-4 text-2xl font-bold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“š Generator Karya Ilmiah</h2>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“ Jenis Karya</label> <select id="researchType" class="w-full p-3 border-2 border-gray-300 rounded-lg"> <option value="skripsi">Skripsi (S1)</option> <option value="tesis">Tesis (S2)</option> <option value="disertasi">Disertasi (S3)</option> </select>
        </div>
        <div><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“– Gaya Sitasi</label> <select id="citationStyle" class="w-full p-3 border-2 border-gray-300 rounded-lg"> <option value="APA">APA (American Psychological Association)</option> <option value="IEEE">IEEE</option> <option value="Chicago">Chicago</option> <option value="Vancouver">Vancouver</option> <option value="Harvard">Harvard</option> </select>
        </div>
       </div>
       <div class="mb-4"><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">âœï¸ Gaya Penulisan</label> <select id="writingStyle" class="w-full p-3 border-2 border-gray-300 rounded-lg"> <option value="akademisi">Akademisi - Formal dan terstruktur dengan teori mendalam</option> <option value="profesional">Profesional - Praktis dan aplikatif untuk dunia kerja</option> <option value="dosen">Dosen - Edukatif dengan penjelasan detail untuk pembelajaran</option> <option value="umum">Umum - Mudah dipahami dengan bahasa sederhana</option> <option value="mendalam">Mendalam - Analisis komprehensif dengan kajian filosofis</option> </select>
       </div>
       <div class="mb-4"><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“ Topik Penelitian</label> <input type="text" id="researchTopic" placeholder="Contoh: Pengaruh Kecerdasan Buatan terhadap Produktivitas Kerja" class="w-full p-3 border-2 border-gray-300 rounded-lg" style="font-family: 'Segoe UI', Tahoma, sans-serif;">
       </div>
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“š Referensi Nasional</label> <input type="number" id="referenceNational" value="10" min="0" max="50" class="w-full p-3 border-2 border-gray-300 rounded-lg">
        </div>
        <div><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸŒ Referensi Internasional</label> <input type="number" id="referenceInternational" value="10" min="0" max="50" class="w-full p-3 border-2 border-gray-300 rounded-lg">
        </div>
        <div><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸŒ Bahasa Output</label> <select id="researchLang" class="w-full p-3 border-2 border-gray-300 rounded-lg"> <option value="id">ğŸ‡®ğŸ‡© Bahasa Indonesia</option> <option value="en">ğŸ‡¬ğŸ‡§ English</option> <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arab)</option> <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª (Jepang)</option> <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡ (China)</option> <option value="de">ğŸ‡©ğŸ‡ª Deutsch (Jerman)</option> <option value="it">ğŸ‡®ğŸ‡¹ Italiano (Italia)</option> <option value="nl">ğŸ‡³ğŸ‡± Nederlands (Belanda)</option> <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais (Prancis)</option> </select>
        </div>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“… Tahun Referensi Dari</label> <input type="number" id="referenceYearFrom" value="2020" min="1990" max="2025" class="w-full p-3 border-2 border-gray-300 rounded-lg">
        </div>
        <div><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“… Tahun Referensi Sampai</label> <input type="number" id="referenceYearTo" value="2025" min="1990" max="2025" class="w-full p-3 border-2 border-gray-300 rounded-lg">
        </div>
        <div><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“„ Pilih Bab</label> <select id="chapterSelect" class="w-full p-3 border-2 border-gray-300 rounded-lg"> <option value="bab1">BAB I - Pendahuluan</option> <option value="bab2">BAB II - Tinjauan Pustaka</option> <option value="bab3">BAB III - Metodologi Penelitian</option> <option value="bab4">BAB IV - Hasil dan Pembahasan</option> <option value="bab5">BAB V - Kesimpulan dan Saran</option> <option value="abstrak">Abstrak</option> <option value="daftar_pustaka">Daftar Pustaka</option> </select>
        </div>
       </div>
       <div class="mb-4"><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“ Panjang Konten</label> <select id="contentLength" class="w-full p-3 border-2 border-gray-300 rounded-lg"> <option value="short">Singkat (Â±3-5 paragraf)</option> <option value="medium" selected>Sedang (Â±5-10 paragraf)</option> <option value="long">Panjang (Â±10-15 paragraf)</option> <option value="very_long">Sangat Panjang (Â±15-20 paragraf)</option> </select>
        <p class="text-sm text-gray-600 mt-2" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ’¡ Pilih panjang konten sesuai kebutuhan. Konten akan disesuaikan otomatis untuk setiap bab.</p>
       </div><button id="generateBtn" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> <span id="research-btn-text">âœ¨ Generate Konten Ilmiah</span> </button>
       <div id="researchLoading" class="hidden mt-4">
        <div class="bg-gray-900 rounded-lg p-4 text-green-400 font-mono text-sm max-h-96 overflow-y-auto" style="font-family: 'Courier New', monospace;">
         <div class="mb-2"><span class="text-blue-400">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—</span><br><span class="text-blue-400">â•‘</span> <span class="text-yellow-400">âš¡ AI RESEARCH ASSISTANT v3.0</span> <span class="text-blue-400">â•‘</span><br><span class="text-blue-400">â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
         </div>
         <div id="terminalOutput" class="space-y-1">
          <div class="text-cyan-400">
           $ Initializing AI Research Generator...
          </div>
         </div>
         <div class="mt-2 flex items-center"><span class="text-green-400 mr-2">â–¶</span>
          <div class="flex space-x-1">
           <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
           <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
           <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
          </div><span id="terminalCursor" class="ml-2 text-green-400 animate-pulse">â–ˆ</span>
         </div>
        </div>
       </div>
      </div>
      <div id="researchResults" class="hidden bg-white rounded-xl p-6 card-shadow mb-6">
       <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“„ Hasil Konten</h2>
        <div class="flex gap-2"><button id="copyResearchBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> ğŸ“‹ Copy </button> <button id="downloadResearchBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> ğŸ’¾ Download </button> <button id="saveResearchBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> ğŸ“Š Simpan </button>
        </div>
       </div>
       <div class="p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded-lg mb-4">
        <p class="font-semibold text-gray-800" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ’¡ Catatan Kredibilitas:</p>
        <p class="text-sm text-gray-700" style="font-family: 'Segoe UI', Tahoma, sans-serif;">Konten di bawah ini sudah termasuk sitasi dalam teks yang terhubung langsung ke Daftar Pustaka dan Format RIS. Kredibilitas akademik terjamin.</p>
       </div>
       <div id="researchContent" class="p-6 bg-gray-50 rounded-lg result-section" style="font-family: 'Segoe UI', Tahoma, sans-serif; white-space: pre-wrap; line-height: 1.8;"></div>
       <div id="referencesSection" class="mt-6">
        <h3 class="text-xl font-bold mb-3" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“š Daftar Pustaka</h3>
        <div id="referencesList" class="p-4 bg-gray-50 rounded-lg mb-4 result-section" style="font-family: 'Segoe UI', Tahoma, sans-serif; white-space: pre-wrap;"></div>
        <div class="mt-4"><button id="toggleRISBtn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> ğŸ“‘ Tampilkan Format RIS </button> <button id="downloadRISBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium hidden" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> â¬‡ï¸ Download RIS </button>
         <div id="risFormat" class="hidden mt-3">
          <h4 class="font-semibold mb-2" style="font-family: 'Segoe UI', Tahoma, sans-serif;">Format RIS (untuk Mendeley/Zotero/EndNote)</h4>
          <div id="risContent" class="ris-entry"></div><button id="copyRISBtn" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> ğŸ“‹ Copy RIS </button>
         </div>
        </div>
       </div>
      </div>
     </div>
     <div id="translationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 px-4">
      <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[90%] overflow-y-auto">
       <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸŒ Terjemahkan Teks</h3><button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
       </div>
       <div class="mb-4"><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">Dari Bahasa</label> <select id="sourceLang" class="w-full p-3 border-2 border-gray-300 rounded-lg"> <option value="id">Indonesia</option> <option value="en">English</option> <option value="ja">Japanese</option> <option value="zh">Chinese</option> <option value="ar">Arabic</option> <option value="fr">French</option> <option value="de">German</option> <option value="es">Spanish</option> </select>
       </div>
       <div class="mb-4"><label class="block mb-2 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;">Ke Bahasa</label> <select id="targetLang" class="w-full p-3 border-2 border-gray-300 rounded-lg"> <option value="en">English</option> <option value="id">Indonesia</option> <option value="ja">Japanese</option> <option value="zh">Chinese</option> <option value="ar">Arabic</option> <option value="fr">French</option> <option value="de">German</option> <option value="es">Spanish</option> </select>
       </div><button id="executeTranslateBtn" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors mb-4 font-semibold" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> âœ¨ Terjemahkan Sekarang </button>
       <div id="translationResult" class="hidden">
        <h4 class="font-semibold mb-2" style="font-family: 'Segoe UI', Tahoma, sans-serif;">Hasil Terjemahan</h4>
        <div id="translatedText" class="p-4 bg-gray-50 rounded-lg max-h-60 overflow-y-auto" style="font-family: 'Segoe UI', Tahoma, sans-serif; white-space: pre-wrap;"></div>
        <div class="flex gap-3 mt-3"><button id="copyTranslationBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> ğŸ“‹ Copy </button> <button id="downloadTranslationBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif;"> ğŸ’¾ Download </button>
        </div>
       </div>
       <div id="translationLoading" class="hidden text-center py-4">
        <div class="loading-spinner mx-auto"></div>
        <p class="mt-2 text-gray-700 font-medium" style="font-family: 'Segoe UI', Tahoma, sans-serif;">Menerjemahkan teks...</p>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-xl p-6 card-shadow mt-6">
      <h2 class="text-xl font-bold mb-4" style="font-family: 'Segoe UI', Tahoma, sans-serif;">ğŸ“š Riwayat</h2>
      <div id="historyList" class="space-y-3">
       <p class="text-gray-500 italic">Riwayat akan muncul di sini setelah Anda menyimpan hasil OCR atau riset.</p>
      </div>
     </div>
    </div>
   </div>
  </div>
  <div id="toastContainer"></div>
  <script>
    // Konfigurasi Default & Variabel Global
    const defaultConfig = {
      app_title: "OCR & Research Assistant",
      upload_button_text: "Pilih Gambar atau Ambil Foto",
      process_button_text: "ğŸ” Ekstrak Teks",
      research_button_text: "âœ¨ Generate Konten Ilmiah",
      instruction_text: "Pilih fitur: OCR Scanner atau Asisten Karya Ilmiah",
      background_color: "#667eea",
      surface_color: "#ffffff",
      text_color: "#1a202c",
      primary_action_color: "#667eea",
      secondary_action_color: "#48bb78",
      font_family: "Segoe UI",
      font_size: 16
    };

    let currentData = [];
    let currentResult = null; // Stores OCR result
    let currentImageFile = null;
    let currentResearchContent = null; // Stores Research result
    let worker = null; // Tesseract Worker instance

    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
    const apiKey = ""; // Canvas provides the key at runtime

    // --- UTILITY FUNCTIONS ---

    function showToast(message, type = "success") {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toastContainer.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('hidden');
        toast.remove();
      }, 3000);
    }

    function downloadFile(content, filename, contentType) {
      try {
        const blob = new Blob([content], { type: contentType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("File berhasil diunduh!", "success");
      } catch (error) {
        console.error("Download failed:", error);
        showToast("Gagal mengunduh file.", "error");
      }
    }

    function copyToClipboard(text, successMessage = "Teks berhasil disalin!") {
      try {
        // Fallback for document.execCommand in iframe environments
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast(successMessage, "success");
      } catch (err) {
        console.error('Copy failed:', err);
        showToast("Gagal menyalin. Silakan coba cara manual.", "error");
      }
    }

    // Exponential Backoff for API calls
    async function fetchWithRetry(url, options, maxRetries = 5) {
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 && attempt < maxRetries - 1) {
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue; // Retry
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${await response.text()}`);
                }
                return response;
            } catch (error) {
                if (attempt === maxRetries - 1) {
                    throw error; // Rethrow if max retries reached
                }
                const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }

    // --- TAB SWITCHING LOGIC ---

    function switchTab(tabName) {
        const isOCR = tabName === 'ocr';
        document.getElementById('ocrSection').classList.toggle('hidden', !isOCR);
        document.getElementById('researchSection').classList.toggle('hidden', isOCR);
        
        document.getElementById('tabOCR').classList.toggle('tab-active', isOCR);
        document.getElementById('tabOCR').classList.toggle('tab-inactive', !isOCR);
        
        document.getElementById('tabResearch').classList.toggle('tab-active', !isOCR);
        document.getElementById('tabResearch').classList.toggle('tab-inactive', isOCR);
        
        document.getElementById('instruction-text').textContent = isOCR 
            ? "Pilih fitur: OCR Scanner atau Asisten Karya Ilmiah"
            : "Buat outline dan konten akademik yang terstruktur.";
    }


    // --- IMAGE HANDLING AND OCR LOGIC ---

    function handleImageSelect(event) {
        const file = event.target.files[0];
        if (file) {
            currentImageFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewImage = document.getElementById('previewImage');
                previewImage.src = e.target.result;
                previewImage.classList.remove('hidden');
                document.getElementById('resultsSection').classList.add('hidden'); // Hide old results
                document.getElementById('processBtn').disabled = false;
                document.getElementById('processBtn').style.opacity = '1';
                document.getElementById('process-btn-text').textContent = 'ğŸ” Ekstrak Teks';
            };
            reader.readAsDataURL(file);
        }
    }

    function processOCRResult(data) {
      const outputFormat = document.getElementById('outputFormat').value;
      const objectLang = document.getElementById('objectLang').value;
      
      let detectedLang = 'Unknown';
      if (objectLang.includes('ind')) detectedLang = 'Indonesia';
      else if (objectLang.includes('eng')) detectedLang = 'English';
      else if (objectLang.includes('jpn')) detectedLang = 'Japanese';
      else if (objectLang.includes('chi_sim')) detectedLang = 'Chinese Simplified';
      else if (objectLang.includes('ara')) detectedLang = 'Arabic';
      else if (objectLang.includes('fra')) detectedLang = 'French';
      else if (objectLang.includes('deu')) detectedLang = 'German';
      else if (objectLang.includes('spa')) detectedLang = 'Spanish';

      const accuracy = data.confidence;
      let extractedText = data.text.trim();
      let summaryText = `Bahasa Terdeteksi: ${detectedLang}. Akurasi Teks: ${accuracy}%. Jumlah Karakter: ${extractedText.length}.`;

      return {
        text: extractedText,
        confidence: accuracy,
        summary: summaryText,
        language: detectedLang,
        format: outputFormat,
        timestamp: new Date().toISOString()
      };
    }

    function displayOCRResults(result) {
      document.getElementById('extractedText').textContent = result.text;
      document.getElementById('summaryText').textContent = result.summary;
      document.getElementById('confidenceText').textContent = `${result.confidence}%`;
      document.getElementById('confidenceBar').style.width = `${result.confidence}%`;
      document.getElementById('resultsSection').classList.remove('hidden');
    }

    async function setupTesseractWorker(lang) {
        if (worker) {
            // Check if language needs to be changed
            const currentLang = worker.getLanguage();
            if (currentLang !== lang) {
                await worker.terminate();
                worker = null;
            }
        }
        
        if (!worker) {
            worker = await Tesseract.createWorker({
                logger: m => {
                    if (m.status === 'downloading' || m.status === 'loading' || m.status === 'initializing' || m.status === 'recognizing') {
                        const statusTextMap = {
                            'downloading': 'Mengunduh data bahasa...',
                            'loading': 'Memuat mesin OCR...',
                            'initializing': 'Menginisialisasi engine...',
                            'recognizing': 'Mengekstrak teks...',
                        };
                        const percentage = m.progress ? (m.progress * 100).toFixed(0) : 0;
                        document.getElementById('loadingText').textContent = statusTextMap[m.status] || m.status;
                        document.getElementById('progressFill').style.width = `${percentage}%`;
                        document.getElementById('progressText').textContent = `${percentage}%`;
                    }
                }
            });
            await worker.loadLanguage(lang);
            await worker.initialize(lang);
        } else {
             // If re-using worker, just reset the UI progress
            document.getElementById('loadingText').textContent = 'Engine siap, mulai ekstraksi...';
            document.getElementById('progressFill').style.width = `0%`;
            document.getElementById('progressText').textContent = `0%`;
        }
    }

    async function handleOCRProcess() {
        if (!currentImageFile) {
            showToast("Mohon pilih gambar terlebih dahulu.", "error");
            return;
        }

        const lang = document.getElementById('objectLang').value;

        // UI state change
        document.getElementById('processBtn').disabled = true;
        document.getElementById('processBtn').style.opacity = '0.6';
        document.getElementById('process-btn-text').textContent = 'Memproses...';
        document.getElementById('loadingIndicator').classList.remove('hidden');
        document.getElementById('resultsSection').classList.add('hidden');
        
        currentResult = null; // Reset previous result

        try {
            await setupTesseractWorker(lang);

            document.getElementById('loadingText').textContent = 'Mengekstrak teks...';

            // Convert image file to recognized format (e.g., URL or Blob)
            const { data: { text, confidence } } = await worker.recognize(currentImageFile);
            
            const rawResult = { text, confidence: (confidence).toFixed(2) };
            currentResult = processOCRResult(rawResult);
            
            displayOCRResults(currentResult);
            showToast("Ekstraksi teks selesai!", "success");

        } catch (error) {
            console.error("OCR Error:", error);
            showToast("Gagal melakukan OCR. Pastikan format gambar didukung.", "error");
        } finally {
            document.getElementById('processBtn').disabled = false;
            document.getElementById('processBtn').style.opacity = '1';
            document.getElementById('process-btn-text').textContent = 'ğŸ” Ekstrak Teks';
            document.getElementById('loadingIndicator').classList.add('hidden');
        }
    }


    // --- RESEARCH ASSISTANT LOGIC (UPDATED WITH IN-TEXT CITATION MANDATE) ---

    function updateTerminalLog(message, isError = false) {
      const terminalOutput = document.getElementById('terminalOutput');
      const logEntry = document.createElement('div');
      logEntry.className = isError ? 'text-red-400' : 'text-green-400';
      logEntry.textContent = `[${new Date().toLocaleTimeString('en-US', { hour12: false })}] $ ${message}`;
      terminalOutput.appendChild(logEntry);
      terminalOutput.scrollTop = terminalOutput.scrollHeight; // Auto-scroll
    }

    function generateSystemInstruction(params) {
      const { researchType, writingStyle, researchLang, citationStyle } = params;
      return `Anda adalah Asisten Peneliti AI tingkat lanjut, bertindak sebagai peneliti senior yang sangat terampil. Tugas Anda adalah menghasilkan konten akademik berkualitas tinggi untuk sebuah ${researchType}.
- Gaya Penulisan: Terapkan gaya '${writingStyle}' yang formal, objektif, dan persuasif.
- Bahasa Output: Tulis seluruh konten dalam bahasa ${researchLang === 'id' ? 'Indonesia' : 'Inggris'}.
- Sitasi & Referensi (KRITIS): Anda HARUS memasukkan sitasi dalam teks (In-Text Citations) yang terperinci (misalnya, [1], (Nama Penulis, Tahun), atau (Judul Sumber Singkat, Tahun)) segera setelah setiap klaim fakta atau data yang diambil dari Google Search. Sitasi ini harus ada di dalam Konten Bab untuk memastikan kredibilitas. Setelah konten, Anda HARUS menghasilkan Daftar Pustaka lengkap di bagian terpisah.
- Batasan Referensi: Semua referensi harus terbaru (tahun ${params.referenceYearFrom} hingga ${params.referenceYearTo}) dan relevan.
- Format Output: Output Anda HARUS memiliki dua bagian, dipisahkan oleh '---REFERENCES---'.
  1. Konten Bab (berupa paragraf teks akademik yang WAJIB memiliki sitasi dalam teks).
  2. Daftar Pustaka (Hanya daftar sitasi yang terperinci dan telah diformat dalam gaya ${citationStyle}).
- Grounding: Anda harus menggunakan Google Search untuk memverifikasi fakta dan mendapatkan data/referensi terbaru. Semua sitasi di Daftar Pustaka harus berasal dari sumber yang digunakan untuk grounding.

Contoh Format Output:
[Konten Bab yang dihasilkan dengan sitasi di dalamnya, seperti: ...produktivitas meningkat (Smith, 2023).]
---REFERENCES---
[Daftar Pustaka terperinci dalam format ${citationStyle}]
`;
    }

    /**
     * Generates RIS format content from grounding sources (URI and Title).
     * Since AU and PY are unavailable, they are estimated for best compatibility.
     */
    function generateRISFormat(sources) {
        if (!sources || sources.length === 0) {
            return "TY - GEN\nER - Tidak ada data referensi web yang ditemukan.";
        }
        let risOutput = "";
        sources.forEach((source, index) => {
            const title = source.title || `Untitled Source ${index + 1}`;
            const uri = source.uri || "N/A";
            
            // Attempt to extract a four-digit year (19xx or 20xx) from the title
            const yearMatch = title.match(/(19|20)\d{2}/);
            const year = yearMatch ? yearMatch[0] : new Date().getFullYear();
            
            // Placeholder for author: try to guess from domain or use a generic one
            const domainMatch = uri.match(/^(?:https?:\/\/)?(?:www\.)?([^\/]+)/i);
            const authorPlaceholder = domainMatch ? domainMatch[1].split('.')[0].toUpperCase() : 'AI_Grounding_System';
            
            // TY - ELEC (Electronic Source, common for web links) or GEN (Generic)
            risOutput += "TY - ELEC\n"; 
            risOutput += `AU - ${authorPlaceholder}, System\n`; // AU format: LastName, FirstName
            risOutput += `TI - ${title}\n`; 
            risOutput += `PY - ${year}\n`; 
            risOutput += `UR - ${uri}\n`; 
            risOutput += "ER - \n"; // End of reference
        });
        return risOutput.trim();
    }


    async function handleResearchGeneration() {
      const topic = document.getElementById('researchTopic').value.trim();
      if (!topic) {
        showToast("Masukkan Topik Penelitian terlebih dahulu.", "error");
        return;
      }

      const params = {
        researchType: document.getElementById('researchType').value,
        citationStyle: document.getElementById('citationStyle').value,
        writingStyle: document.getElementById('writingStyle').value,
        researchLang: document.getElementById('researchLang').value,
        referenceNational: document.getElementById('referenceNational').value,
        referenceInternational: document.getElementById('referenceInternational').value,
        referenceYearFrom: document.getElementById('referenceYearFrom').value,
        referenceYearTo: document.getElementById('referenceYearTo').value,
        chapter: document.getElementById('chapterSelect').value,
        contentLength: document.getElementById('contentLength').value,
      };

      // Toggle UI for loading
      document.getElementById('generateBtn').disabled = true;
      document.getElementById('generateBtn').style.opacity = '0.6';
      document.getElementById('researchLoading').classList.remove('hidden');
      document.getElementById('researchResults').classList.add('hidden');
      document.getElementById('terminalOutput').innerHTML = '';
      updateTerminalLog(`Target: ${params.researchType} | Topik: ${topic}`);
      updateTerminalLog(`Chapter: ${params.chapter} | Gaya: ${params.citationStyle}`);
      updateTerminalLog(`â³ Mengumpulkan ${params.referenceNational} ref nasional & ${params.referenceInternational} ref internasional...`);
      
      const systemPrompt = generateSystemInstruction(params);
      let userQuery;

      const lengthMapping = {
        'short': 'sekitar 3-5 paragraf, ringkas',
        'medium': 'sekitar 5-10 paragraf, sedang',
        'long': 'sekitar 10-15 paragraf, detail',
        'very_long': 'sekitar 15-20 paragraf, sangat mendalam'
      };

      if (params.chapter === 'daftar_pustaka') {
          userQuery = `Berdasarkan topik penelitian: "${topic}", tolong buatkan Daftar Pustaka saja (tidak perlu konten bab) dengan jumlah referensi ${parseInt(params.referenceNational) + parseInt(params.referenceInternational)} jurnal/sumber yang paling relevan dan terbaru (${params.referenceYearFrom}-${params.referenceYearTo}). Gunakan format ${params.citationStyle}.`;
          
      } else if (params.chapter === 'abstrak') {
          userQuery = `Tulis Abstract (${lengthMapping[params.contentLength]}) untuk ${params.researchType} dengan topik "${topic}". Pastikan format abstrak mencakup masalah, tujuan, metode (jika relevan), hasil utama, dan kesimpulan. Sertakan sitasi yang relevan dalam teks.`;

      } else {
          // Standard chapter request
          const chapterTitle = document.querySelector(`#chapterSelect option[value="${params.chapter}"]`).textContent;
          userQuery = `Tuliskan konten untuk ${chapterTitle} (${lengthMapping[params.contentLength]}) dari ${params.researchType} dengan topik "${topic}". Pastikan semua argumen didukung oleh fakta dan WAJIB menyertakan sitasi dalam teks yang akurat dari sumber web terbaru.`;
      }
      
      updateTerminalLog(`âš™ï¸ Mengirimkan query ke AI... (Memastikan sitasi dalam teks WAJIB ada)`);

      const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        tools: [{ "google_search": {} }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
      };

      try {
        const response = await fetchWithRetry(GEMINI_API_URL + apiKey, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        const candidate = result.candidates?.[0];

        if (!candidate || !candidate.content?.parts?.[0]?.text) {
          updateTerminalLog("âŒ Gagal mendapatkan respons dari model. Silakan coba lagi.", true);
          throw new Error("Invalid model response structure.");
        }

        const rawText = candidate.content.parts[0].text;
        let sources = [];
        const groundingMetadata = candidate.groundingMetadata;
        if (groundingMetadata && groundingMetadata.groundingAttributions) {
            sources = groundingMetadata.groundingAttributions
                .map(attribution => ({
                    uri: attribution.web?.uri,
                    title: attribution.web?.title,
                }))
                .filter(source => source.uri && source.title);
        }

        updateTerminalLog(`âœ… Mendapat ${sources.length} sumber referensi dari Google Search.`);
        updateTerminalLog("ğŸ“ Memproses konten dan daftar pustaka...");

        // Separate content and references
        const parts = rawText.split('---REFERENCES---');
        const contentText = parts[0].trim();
        const rawReferences = parts[1] ? parts[1].trim() : "Daftar pustaka akan dibuat dari hasil grounding yang ditemukan.";
        
        // Format the content for display 
        document.getElementById('researchContent').textContent = contentText;

        // Display formatted references
        document.getElementById('referencesList').textContent = rawReferences; 

        // Generate RIS format from the actual grounding sources
        const risContent = generateRISFormat(sources);
        document.getElementById('risContent').textContent = risContent;

        // Store the result
        currentResearchContent = {
          topic: topic,
          chapter: document.querySelector(`#chapterSelect option[value="${params.chapter}"]`).textContent,
          content: contentText,
          rawReferences: rawReferences, 
          groundingSources: sources, 
          citationStyle: params.citationStyle,
          risContent: risContent, // Store RIS content
          timestamp: new Date().toISOString()
        };

        updateTerminalLog("ğŸ‰ Generasi konten ilmiah selesai!");
        document.getElementById('researchResults').classList.remove('hidden');
        document.getElementById('downloadRISBtn').classList.remove('hidden'); // Show download RIS button
        showToast("Konten ilmiah berhasil digenerate!", "success");

      } catch (error) {
        console.error("Research generation error:", error);
        updateTerminalLog(`Fatal Error: ${error.message}`, true);
        showToast("Gagal men-generate konten ilmiah. Cek konsol untuk detail.", "error");
      } finally {
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('generateBtn').style.opacity = '1';
        document.getElementById('researchLoading').classList.add('hidden');
      }
    }

    // --- TRANSLATION LOGIC ---

    async function handleTranslation() {
      const textToTranslate = currentResult?.text || document.getElementById('extractedText').textContent.trim();
      const sourceLang = document.getElementById('sourceLang').value;
      const targetLang = document.getElementById('targetLang').value;

      if (!textToTranslate) {
        showToast("Tidak ada teks yang diekstrak untuk diterjemahkan.", "error");
        return;
      }

      // Toggle UI
      const modal = document.getElementById('translationModal');
      const loading = document.getElementById('translationLoading');
      const resultDiv = document.getElementById('translationResult');
      const executeBtn = document.getElementById('executeTranslateBtn');

      executeBtn.disabled = true;
      loading.classList.remove('hidden');
      resultDiv.classList.add('hidden');
      document.getElementById('translatedText').textContent = 'Menerjemahkan...';

      const userQuery = `Terjemahkan teks berikut dari bahasa ${sourceLang.toUpperCase()} ke bahasa ${targetLang.toUpperCase()}. Pertahankan format paragraf aslinya.\n\nTEKS:\n${textToTranslate}`;
      const systemPrompt = "Anda adalah penerjemah profesional. Jaga keakuratan dan gaya formal.";

      const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
      };

      try {
        const response = await fetchWithRetry(GEMINI_API_URL + apiKey, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        const translatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

        if (!translatedText) {
          throw new Error("Gagal mendapatkan hasil terjemahan.");
        }

        document.getElementById('translatedText').textContent = translatedText;
        resultDiv.classList.remove('hidden');
        showToast("Terjemahan berhasil!", "success");

      } catch (error) {
        console.error("Translation error:", error);
        document.getElementById('translatedText').textContent = "Terjadi kesalahan saat menerjemahkan: " + error.message;
        resultDiv.classList.remove('hidden');
        showToast("Gagal melakukan terjemahan.", "error");
      } finally {
        executeBtn.disabled = false;
        loading.classList.add('hidden');
      }
    }


    // --- DATA HANDLING AND HISTORY ---

    const dataHandler = {
      onDataChanged(data) {
        currentData = data;
        renderHistory();
      }
    };

    async function saveToDataSdk(type, content) {
        if (!window.dataSdk) {
            showToast("Data SDK tidak tersedia. Data tidak dapat disimpan.", "error");
            return;
        }

        const dataItem = {
            id: crypto.randomUUID(),
            type: type, // 'ocr' or 'research'
            ...content
        };

        const result = await window.dataSdk.set([dataItem, ...currentData]);
        if (result.isOk) {
            showToast(`${type === 'ocr' ? 'Hasil OCR' : 'Konten Riset'} berhasil disimpan!`, "success");
        } else {
            showToast("Gagal menyimpan data ke Canvas Sheet.", "error");
        }
    }

    function renderHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';

      if (currentData.length === 0) {
        historyList.innerHTML = '<p class="text-gray-500 italic">Riwayat akan muncul di sini setelah Anda menyimpan hasil OCR atau riset.</p>';
        return;
      }

      currentData.forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'p-4 rounded-lg border border-gray-200 shadow-sm transition-shadow duration-200 hover:shadow-md cursor-pointer chapter-item';
        
        let title = '';
        let subtitle = '';

        if (item.type === 'ocr') {
          title = `ğŸ“¸ OCR - ${item.language} (${item.confidence}%)`;
          subtitle = item.text.substring(0, 100).replace(/\n/g, ' ') + '...';
          historyItem.classList.add('bg-blue-50');
        } else if (item.type === 'research') {
          title = `ğŸ“ Riset - ${item.chapter} (${item.topic.substring(0, 50)}...)`;
          subtitle = item.content.substring(0, 100).replace(/\n/g, ' ') + '...';
          historyItem.classList.add('bg-purple-50');
        }

        historyItem.innerHTML = `
          <div class="flex justify-between items-start">
              <div class="flex-1">
                  <p class="font-semibold text-gray-800">${title}</p>
                  <p class="text-xs text-gray-500 mb-2">${new Date(item.timestamp).toLocaleString()}</p>
                  <p class="text-sm text-gray-600">${subtitle}</p>
              </div>
          </div>
        `;
        // No click handler for simplicity, but could be added to re-display results
        historyList.appendChild(historyItem);
      });
    }

    // --- INITIALIZATION AND EVENT LISTENERS ---

    async function initSDKs() {
      // FIX: Tambahkan pengecekan if(window.dataSdk) untuk mengatasi TypeError jika SDK belum dimuat.
      if (window.dataSdk) {
        const dataResult = await window.dataSdk.init(dataHandler);
        if (!dataResult.isOk) {
          showToast("Gagal menginisialisasi penyimpanan data", "error");
        }
      } else {
         console.warn("Canvas Data SDK (dataSdk) tidak ditemukan. Fitur penyimpanan data akan dinonaktifkan.");
      }


      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            // Apply dynamic config changes (simplified for brevity)
            const customFont = config.font_family || defaultConfig.font_family;
            const baseFontStack = 'Tahoma, sans-serif';
            const fontFamily = `${customFont}, ${baseFontStack}`;
            
            document.querySelectorAll('[style*="font-family"]').forEach(el => el.style.fontFamily = fontFamily);

            const bgColor = config.background_color || defaultConfig.background_color;
            const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
            const secondaryColor = config.secondary_action_color || defaultConfig.secondary_action_color;
            
            // Background gradient update (simplified)
            document.querySelector('.gradient-bg').style.background = `linear-gradient(135deg, ${bgColor} 0%, #764ba2 100%)`;
            
            // Buttons and active tab colors (needs dynamic updating based on active state)
            const processBtn = document.getElementById('processBtn');
            if (processBtn) processBtn.style.backgroundColor = primaryColor;
            
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) generateBtn.style.backgroundColor = primaryColor;

            const tabOCR = document.getElementById('tabOCR');
            if (tabOCR && tabOCR.classList.contains('tab-active')) tabOCR.style.backgroundColor = primaryColor;
            
            document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
            document.getElementById('upload-label').textContent = config.upload_button_text || defaultConfig.upload_button_text;
            document.getElementById('process-btn-text').textContent = config.process_button_text || defaultConfig.process_button_text;
            document.getElementById('research-btn-text').textContent = config.research_button_text || defaultConfig.research_button_text;
            document.getElementById('instruction-text').textContent = config.instruction_text || defaultConfig.instruction_text;

          },
          mapToCapabilities: (config) => ({
            recolorables: [
              { get: () => config.background_color || defaultConfig.background_color, set: (value) => window.elementSdk.setConfig({ background_color: value }) },
              { get: () => config.surface_color || defaultConfig.surface_color, set: (value) => window.elementSdk.setConfig({ surface_color: value }) },
              { get: () => config.text_color || defaultConfig.text_color, set: (value) => window.elementSdk.setConfig({ text_color: value }) },
              { get: () => config.primary_action_color || defaultConfig.primary_action_color, set: (value) => window.elementSdk.setConfig({ primary_action_color: value }) },
              { get: () => config.secondary_action_color || defaultConfig.secondary_action_color, set: (value) => window.elementSdk.setConfig({ secondary_action_color: value }) }
            ],
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["upload_button_text", config.upload_button_text || defaultConfig.upload_button_text],
            ["process_button_text", config.process_button_text || defaultConfig.process_button_text],
            ["research_button_text", config.research_button_text || defaultConfig.research_button_text],
            ["instruction_text", config.instruction_text || defaultConfig.instruction_text]
          ])
        });
      }
    }


    // --- ATTACH ALL EVENT LISTENERS ---

    // 1. Tab Switching
    document.getElementById('tabOCR').addEventListener('click', () => switchTab('ocr'));
    document.getElementById('tabResearch').addEventListener('click', () => switchTab('research'));

    // 2. Image Input Handling
    document.getElementById('uploadBtn').addEventListener('click', () => {
        document.getElementById('imageInputGallery').click();
    });
    document.getElementById('cameraBtn').addEventListener('click', () => {
        document.getElementById('imageInputCamera').click();
    });
    document.getElementById('imageInputGallery').addEventListener('change', handleImageSelect);
    document.getElementById('imageInputCamera').addEventListener('change', handleImageSelect);

    // 3. OCR Processing
    document.getElementById('processBtn').addEventListener('click', handleOCRProcess);

    // 4. OCR Results Actions
    document.getElementById('downloadBtn').addEventListener('click', function() {
      if (currentResult) {
        const format = document.getElementById('outputFormat').value;
        let content = currentResult.text;
        let contentType = 'text/plain';
        let extension = '.txt';

        if (format === 'word') {
          // Creating a simple DOC-like file (Word handles HTML content)
          // Use basic HTML to ensure it opens well in Word
          content = `
            <html>
            <head><meta charset="UTF-8"><title>Hasil OCR</title></head>
            <body><p>${content.replace(/\n\s*\n/g, '</p><p>').replace(/\n/g, '<br>')}</p></body>
            </html>
          `;
          contentType = 'application/msword';
          extension = '.doc';
        } else if (format === 'markdown') {
          // Convert text to markdown by double-spacing paragraphs
          content = currentResult.text.split('\n').filter(Boolean).map(p => p.trim()).join('\n\n');
          contentType = 'text/markdown';
          extension = '.md';
        } else if (format === 'csv') {
          // Basic CSV support (one cell for the entire text)
          content = `"Extracted Text"\n"${content.replace(/"/g, '""').replace(/\n/g, ' ')}"`;
          contentType = 'text/csv';
          extension = '.csv';
        }
        
        downloadFile(content, `OCR_Result${extension}`, contentType);
      } else {
        showToast("Tidak ada hasil OCR untuk diunduh.", "error");
      }
    });

    document.getElementById('copyOCRBtn').addEventListener('click', function() {
      if (currentResult) {
        copyToClipboard(currentResult.text, "Teks OCR berhasil disalin!");
      } else {
        showToast("Tidak ada teks untuk disalin.", "error");
      }
    });

    document.getElementById('saveOCRBtn').addEventListener('click', function() {
      if (currentResult) {
        saveToDataSdk('ocr', currentResult);
      } else {
        showToast("Tidak ada hasil OCR untuk disimpan.", "error");
      }
    });

    document.getElementById('translateBtn').addEventListener('click', function() {
      if (currentResult?.text) {
        document.getElementById('translationModal').classList.remove('hidden');
        document.getElementById('translatedText').textContent = 'Tekan "Terjemahkan Sekarang" untuk memulai.';
        document.getElementById('translationResult').classList.add('hidden');
        document.getElementById('translationLoading').classList.add('hidden');
      } else {
        showToast("Lakukan OCR terlebih dahulu untuk mendapatkan teks terjemahan.", "error");
      }
    });

    // 5. Translation Modal Listeners
    document.getElementById('closeModalBtn').addEventListener('click', () => {
      document.getElementById('translationModal').classList.add('hidden');
    });
    document.getElementById('executeTranslateBtn').addEventListener('click', handleTranslation);
    document.getElementById('copyTranslationBtn').addEventListener('click', () => {
      const text = document.getElementById('translatedText').textContent;
      copyToClipboard(text, "Hasil terjemahan berhasil disalin!");
    });
    document.getElementById('downloadTranslationBtn').addEventListener('click', () => {
      const text = document.getElementById('translatedText').textContent;
      downloadFile(text, `Translation_Result_${document.getElementById('targetLang').value}.txt`, 'text/plain');
    });


    // 6. Research Assistant Listeners
    document.getElementById('generateBtn').addEventListener('click', handleResearchGeneration);

    document.getElementById('copyResearchBtn').addEventListener('click', function() {
      if (currentResearchContent) {
        copyToClipboard(currentResearchContent.content, "Konten ilmiah berhasil disalin!");
      } else {
        showToast("Tidak ada konten riset untuk disalin.", "error");
      }
    });

    // UPDATED: Research Download to .doc format
    document.getElementById('downloadResearchBtn').addEventListener('click', function() {
      if (currentResearchContent) {
        const chapterTitle = currentResearchContent.chapter;
        // Replace double newlines with closing/opening p tags, and single newlines with br for better Word formatting
        const researchContentHtml = currentResearchContent.content.replace(/\n\s*\n/g, '</p><p>').replace(/\n/g, '<br>'); 
        const referencesHtml = document.getElementById('referencesList').textContent.replace(/\n/g, '<br>');
        const topic = currentResearchContent.topic;

        const htmlContent = `
            <html>
            <head>
                <meta charset="UTF-8">
                <title>${chapterTitle} - ${topic}</title>
                <style>
                    /* Minimal styling for clean Word import */
                    body { font-family: Arial, sans-serif; line-height: 1.6; margin: 50px; }
                    h1 { color: #333; font-size: 24pt; margin-bottom: 20px; text-align: center;}
                    h2 { color: #555; font-size: 14pt; margin-top: 30px; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
                    p { margin-bottom: 1em; text-align: justify; }
                    .references { margin-top: 40px; }
                </style>
            </head>
            <body>
                <h1>${chapterTitle}</h1>
                <p style="text-align:center; font-style: italic;">Topik: ${topic}</p>
                
                <h2>Isi Konten</h2>
                <p>${researchContentHtml}</p>
                
                <div class="references">
                    <h2>Daftar Pustaka</h2>
                    <p>${referencesHtml}</p>
                </div>
            </body>
            </html>
        `;

        downloadFile(htmlContent, `${topic.replace(/[^a-zA-Z0-9]/g, '_')}_${chapterTitle.replace(/[^a-zA-Z0-9]/g, '_')}.doc`, 'application/msword');
      } else {
        showToast("Tidak ada konten riset untuk diunduh.", "error");
      }
    });

    document.getElementById('saveResearchBtn').addEventListener('click', function() {
      if (currentResearchContent) {
        saveToDataSdk('research', currentResearchContent);
      } else {
        showToast("Tidak ada konten riset untuk disimpan.", "error");
      }
    });
    
    document.getElementById('toggleRISBtn').addEventListener('click', function() {
        const risFormat = document.getElementById('risFormat');
        const downloadBtn = document.getElementById('downloadRISBtn');
        const isHidden = risFormat.classList.contains('hidden');
        if (isHidden) {
            risFormat.classList.remove('hidden');
            downloadBtn.classList.remove('hidden');
            this.textContent = 'ğŸ‘† Sembunyikan Format RIS';
        } else {
            risFormat.classList.add('hidden');
            downloadBtn.classList.add('hidden');
            this.textContent = 'ğŸ“‘ Tampilkan Format RIS';
        }
    });

    document.getElementById('copyRISBtn').addEventListener('click', function() {
        const risText = document.getElementById('risContent').textContent;
        copyToClipboard(risText, "Format RIS berhasil disalin!");
    });
    
    document.getElementById('downloadRISBtn').addEventListener('click', function() {
        if (currentResearchContent && currentResearchContent.risContent) {
            const topic = currentResearchContent.topic;
            downloadFile(currentResearchContent.risContent, `${topic.replace(/[^a-zA-Z0-9]/g, '_')}_RIS.ris`, 'application/x-research-info-systems');
        } else {
            showToast("Tidak ada data RIS untuk diunduh. Generate konten riset terlebih dahulu.", "error");
        }
    });

    // Initialize the SDKs on load
    window.onload = initSDKs;
  </script>
 </body>
</html>
